#!/bin/bash
# ----------------------------------------
# Raindrop Bookmark Script (macOS Shortcut Safe)
# ----------------------------------------
# Supports: direct URL args OR clipboard fallback
# Logs to /tmp (auto-cleaned by macOS)
# ----------------------------------------

set -euo pipefail

# 🔐 Raindrop API token
RAINDROP_TOKEN="ab0ef098-8f2a-4d54-87a4-033ff29614a1"

# ----------------------------------------
# Helper: macOS notification
# ----------------------------------------
notify() {
  local msg="$1"
  local title="${2:-Raindrop}"
  local sound="${3:-}"
  if command -v terminal-notifier &>/dev/null; then
    if [[ -n "$sound" ]]; then
      terminal-notifier -title "$title" -message "$msg" -sound "$sound" >/dev/null 2>&1
    else
      terminal-notifier -title "$title" -message "$msg" >/dev/null 2>&1
    fi
  fi
}

# ----------------------------------------
# Inputs
# ----------------------------------------
ARG1="${1:-}"
ARG2="${2:-Quick Add}"
ARG3="${3:-script}"

# ----------------------------------------
# Extract URL from clipboard if not provided
# ----------------------------------------
extract_url_from_clipboard() {
  pbpaste | grep -Eo 'https?://[^[:space:]]+' | sed 's/[.,;:!?]$//' | head -n 1
}

if [[ -n "$ARG1" && "$ARG1" =~ ^https?:// ]]; then
  URL="$ARG1"
else
  URL=$(extract_url_from_clipboard)
fi

if [[ -z "$URL" ]]; then
  notify "📋 No valid URL found to bookmark." "Raindrop ❌" Basso
  exit 0
fi

# ----------------------------------------
# Send to Raindrop API
# ----------------------------------------
response=$(curl -s -X POST "https://api.raindrop.io/rest/v1/raindrop" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $RAINDROP_TOKEN" \
  -d "{
    \"link\": \"$URL\",
    \"title\": \"$ARG2\",
    \"tags\": [\"$ARG3\"]
  }")

# ----------------------------------------
# Validate success using real API field
# ----------------------------------------
if echo "$response" | jq -e '._id // .item._id // empty' >/dev/null; then
  notify "✅ Bookmark added successfully!" "Raindrop"
else
  notify "❌ Failed to add bookmark." "Raindrop" Basso
fi

# ----------------------------------------
# Log to macOS /tmp (auto-cleaned)
# ----------------------------------------
LOG_FILE="/tmp/raindrop_$(whoami).log"
{
  echo "[$(date '+%Y-%m-%d %H:%M:%S')] $URL | Title: $ARG2 | Tag: $ARG3"
} >>"$LOG_FILE" 2>/dev/null || true

exit 0
