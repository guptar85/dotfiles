#!/usr/bin/env bash
set -euo pipefail

# ==========================================================
# ğŸ”— Dotfiles Symlink Setup (Interactive + Safe)
# ==========================================================

DOTFILES_DIR="$HOME/dotfiles"
CONFIG_DIR="$DOTFILES_DIR/config"
TARGET_DIR="$HOME/.config"

echo "ğŸ”— Setting up symbolic links from dotfiles â†’ ~/.config"
echo "===================================================="

# Ask user for mode selection interactively (always show)
if [ -t 0 ]; then
  echo ""
  echo "Select mode:"
  echo "1) ğŸ§ª Dry Run (preview only)"
  echo "2) âš™ï¸ Actual Run (create symlinks)"
  echo "3) ğŸš« Exit (no action)"
  echo ""
  read -r -p "Enter your choice [1/2/3]: " choice
else
  # Fallback: default to dry-run when not interactive (e.g. piping)
  choice="1"
fi

case "$choice" in
1)
  MODE="dry-run"
  echo "ğŸ§ª Running in dry-run mode (no changes will be made)."
  ;;
2)
  MODE="run"
  echo "âš™ï¸ Running in actual mode (changes will be applied)."
  ;;
3)
  echo "ğŸš« No action taken. Exiting."
  exit 0
  ;;
*)
  echo "âŒ Invalid choice. Exiting."
  exit 1
  ;;
esac

# Ensure ~/.config exists
if [ ! -d "$TARGET_DIR" ]; then
  echo "ğŸ“ Creating $TARGET_DIR ..."
  [ "$MODE" = "run" ] && mkdir -p "$TARGET_DIR"
fi

# Function: create a safe symlink
create_symlink() {
  local src="$1"
  local dest="$2"

  if [ "$MODE" = "dry-run" ]; then
    if [ -L "$dest" ]; then
      echo "ğŸŸ¡ Would update symlink: $dest â†’ $src"
    elif [ -e "$dest" ]; then
      echo "ğŸŸ¡ Would back up existing: $dest â†’ ${dest}.backup"
    else
      echo "ğŸŸ¢ Would create new symlink: $dest â†’ $src"
    fi
    return
  fi

  if [ -L "$dest" ]; then
    echo "âš™ï¸  Updating existing symlink: $dest"
    ln -sf "$src" "$dest"
  elif [ -e "$dest" ]; then
    echo "ğŸ“¦ Backing up existing: $dest â†’ ${dest}.backup"
    mv "$dest" "${dest}.backup"
    ln -s "$src" "$dest"
    echo "âœ… Linked $dest â†’ $src"
  else
    ln -s "$src" "$dest"
    echo "âœ… Linked $dest â†’ $src"
  fi
}

# Loop through config directories
for dir in "$CONFIG_DIR"/*; do
  [ -d "$dir" ] || continue
  name=$(basename "$dir")
  src="$dir"
  dest="$TARGET_DIR/$name"
  create_symlink "$src" "$dest"
done

# Link top-level dotfiles
echo ""
echo "ğŸ”— Linking shell and top-level configs..."
for file in ".zshrc" ".p10k.zsh" ".zprofile"; do
  if [ -f "$DOTFILES_DIR/$file" ]; then
    create_symlink "$DOTFILES_DIR/$file" "$HOME/$file"
  fi
done

echo ""
if [ "$MODE" = "dry-run" ]; then
  echo "ğŸ§ª Dry-run complete â€” no files were modified."
else
  echo "âœ… All symbolic links created successfully!"
  echo "ğŸ’¡ You can now restart your terminal to apply changes."
fi
